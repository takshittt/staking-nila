generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Admin {
  id              Int        @id @default(1)
  passwordHash    String
  twoFactorSecret String     @db.Text
  backupCodes     String     @db.Text
  isSetupComplete Boolean    @default(false)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  lastLoginAt     DateTime?
  auditLogs       AuditLog[]

  @@map("admin")
}

model AuditLog {
  id        String   @id @default(uuid())
  adminId   Int
  action    String
  txHash    String?
  createdAt DateTime @default(now())
  admin     Admin    @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([createdAt])
  @@map("audit_logs")
}

model ContractCache {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  expiresAt DateTime

  @@index([key])
  @@map("contract_cache")
}

model User {
  id               String          @id @default(uuid())
  walletAddress    String          @unique
  referralCode     String?         @unique
  referredBy       String?
  isReferralSkipped Boolean         @default(false)
  status           String          @default("active")
  firstConnectedAt DateTime        @default(now())
  lastSeenAt       DateTime        @updatedAt
  pendingRewards   PendingReward[]
  stakes           Stake[]

  @@index([walletAddress])
  @@index([referralCode])
  @@map("users")
}

model Stake {
  id            String   @id @default(uuid())
  stakeId       String   @unique
  userId        String
  planName      String
  planVersion   Int
  amount        Decimal  @db.Decimal(20, 8)
  apy           Decimal  @db.Decimal(5, 2)
  startDate     DateTime
  endDate       DateTime
  status        String   @default("active")
  txHash        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("stakes")
}

model Referral {
  id             String   @id @default(uuid())
  referrerWallet String
  referredWallet String
  earnings       Decimal  @db.Decimal(20, 8)
  createdAt      DateTime @default(now())

  @@index([referrerWallet])
  @@index([referredWallet])
  @@map("referrals")
}

model ReferralConfig {
  id                 Int      @id @default(1)
  referralPercentage Decimal  @db.Decimal(5, 2)
  referrerPercentage Decimal  @db.Decimal(5, 2)
  isPaused           Boolean  @default(false)
  updatedAt          DateTime @updatedAt

  @@map("referral_config")
}

model PendingReward {
  id            String    @id @default(uuid())
  userId        String
  walletAddress String
  type          String
  amount        Decimal   @db.Decimal(20, 8)
  status        String    @default("pending")
  sourceId      String?
  metadata      Json?
  createdAt     DateTime  @default(now())
  claimedAt     DateTime?
  txHash        String?
  user          User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([walletAddress])
  @@index([status])
  @@index([type])
  @@map("pending_rewards")
}

model Transaction {
  id            String    @id @default(uuid())
  txHash        String    @unique
  walletAddress String?
  type          String
  amount        Decimal?  @db.Decimal(20, 8)
  status        String    @default("pending")
  createdAt     DateTime  @default(now())
  confirmedAt   DateTime?

  @@index([txHash])
  @@index([walletAddress])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}
