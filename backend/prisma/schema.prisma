generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Admin {
  id              String     @id @default(auto()) @map("_id") @db.ObjectId
  passwordHash    String
  twoFactorSecret String
  backupCodes     String
  isSetupComplete Boolean    @default(false)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  lastLoginAt     DateTime?
  auditLogs       AuditLog[]

  @@map("admin")
}

model AuditLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  adminId   String   @db.ObjectId
  action    String
  txHash    String?
  createdAt DateTime @default(now())
  admin     Admin    @relation(fields: [adminId], references: [id])

  @@map("audit_logs")
}

model ContractCache {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique
  value     Json
  expiresAt DateTime

  @@map("contract_cache")
}

model User {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  walletAddress     String          @unique
  referralCode      String?         @unique
  referredBy        String?
  isReferralSkipped Boolean         @default(false)
  status            String          @default("active")
  firstConnectedAt  DateTime        @default(now())
  lastSeenAt        DateTime        @updatedAt
  pendingRewards    PendingReward[]
  stakes            Stake[]

  @@map("users")
}

model Stake {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  stakeId     String   @unique
  userId      String   @db.ObjectId
  planName    String
  planVersion Int
  amount      String
  apy         String
  startDate   DateTime
  endDate     DateTime
  status      String   @default("active")
  txHash      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id])

  @@map("stakes")
}

model Referral {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  referrerWallet String
  referredWallet String
  earnings       String
  createdAt      DateTime @default(now())

  @@map("referrals")
}

model ReferralConfig {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  referralPercentage String
  referrerPercentage String
  isPaused           Boolean  @default(false)
  updatedAt          DateTime @updatedAt

  @@map("referral_config")
}

model PendingReward {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  userId        String    @db.ObjectId
  walletAddress String
  type          String
  amount        String
  status        String    @default("pending")
  sourceId      String?
  metadata      Json?
  createdAt     DateTime  @default(now())
  claimedAt     DateTime?
  txHash        String?
  user          User      @relation(fields: [userId], references: [id])

  @@map("pending_rewards")
}

model Transaction {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  txHash        String    @unique
  walletAddress String?
  type          String
  amount        String?
  status        String    @default("pending")
  createdAt     DateTime  @default(now())
  confirmedAt   DateTime?

  @@map("transactions")
}

model PaymentIntent {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  invoiceId      String   @unique
  intentId       String?  @unique
  walletAddress  String
  email          String
  name           String
  amount         String   // USD amount
  nilaAmount     String   // Calculated NILA tokens
  amountConfigId Int
  lockConfigId   Int
  status         String   @default("PENDING") // PENDING, SUCCESS, FAILED, CANCELLED
  paymentMethod  String   @default("CARD")
  txHash         String?  // Blockchain transaction hash after stake creation
  stakeId        String?  // Reference to created stake
  metadata       Json?    // Additional data (billing info, email tracking, etc.)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("payment_intents")
}
